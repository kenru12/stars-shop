<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stars Shop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-pure: #000000;
            --bg-card: #121212;
            --tg-button: #2481cc;
            --tg-hint: #888888;
        }

        body {
            margin: 0; background-color: var(--bg-pure); color: #fff;
            font-family: -apple-system, system-ui, sans-serif;
            overflow: hidden; height: 100vh;
        }

        /* –§–æ–Ω —Å–æ –∑–≤–µ–∑–¥–∞–º–∏ */
        canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 0; opacity: 0.7; }
        
        .app { position: relative; z-index: 1; height: 100vh; display: flex; flex-direction: column; }
        
        /* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å */
        .content { flex: 1; overflow-y: auto; padding: 16px; padding-top: 50px; padding-bottom: 120px; }

        /* –ë–ê–ù–ï–† */
        .promo-banner {
            background: linear-gradient(135deg, #1d2733 0%, #2481cc 100%);
            border-radius: 16px; padding: 20px; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: space-between;
        }

        /* –ò–ù–ü–£–¢ –° –ê–í–ê–¢–ê–†–ö–û–ô */
        .input-group { 
            background: var(--bg-card); border-radius: 14px; 
            padding: 4px 12px; margin-bottom: 12px; 
            display: flex; align-items: center; min-height: 56px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        /* –ú–ê–ì–ò–Ø –ü–õ–ê–í–ù–û–ì–û –ü–û–Ø–í–õ–ï–ù–ò–Ø */
        .avatar-slot { 
            width: 0;            /* –°–∫—Ä—ã—Ç–æ */
            height: 34px; 
            border-radius: 50%; 
            overflow: hidden; 
            margin-right: 0; 
            opacity: 0;          /* –ü—Ä–æ–∑—Ä–∞—á–Ω–æ */
            transform: scale(0.5); /* –£–º–µ–Ω—å—à–µ–Ω–æ */
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è */
            background: #333;
        }
        
        /* –ö–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–±–∞–≤–ª—è–µ—Ç JS, –∫–æ–≥–¥–∞ –Ω–∞—à–µ–ª —Ñ–æ—Ç–æ */
        .avatar-slot.visible { 
            width: 34px; 
            margin-right: 12px; 
            opacity: 1; 
            transform: scale(1); 
        }
        
        .avatar-slot img { width: 100%; height: 100%; object-fit: cover; }

        input { flex: 1; background: transparent; border: none; color: #fff; font-size: 16px; outline: none; }
        .btn-self { background: var(--tg-button); color: #fff; border: none; border-radius: 18px; padding: 6px 14px; font-size: 13px; font-weight: 600; cursor: pointer; }

        /* –°–ï–¢–ö–ê –ó–í–ï–ó–î */
        .stars-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; margin-top: 16px; }
        .star-card { 
            background: var(--bg-card); border-radius: 12px; 
            padding: 12px; text-align: center; border: 1px solid transparent; transition: 0.2s; cursor: pointer;
        }
        .star-card.active { border-color: var(--tg-button); background: rgba(36, 129, 204, 0.1); }
        .star-card b { display: block; font-size: 16px; color: #f9d43d; margin-bottom: 4px; }
        .star-card span { font-size: 12px; color: var(--tg-hint); }

        /* –û–ü–õ–ê–¢–ê */
        .label-txt { color: var(--tg-hint); font-size: 13px; margin-bottom: 8px; display: block; }
        .pay-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .pay-item { background: var(--bg-card); border-radius: 12px; padding: 16px; text-align: center; border: 1px solid transparent; font-weight: 600; font-size: 14px; cursor: pointer; }
        .pay-item.active { border-color: var(--tg-button); background: rgba(36, 129, 204, 0.1); }

        .main-btn { background: var(--tg-button); color: #fff; width: 100%; border: none; border-radius: 14px; padding: 16px; font-size: 16px; font-weight: 700; cursor: pointer; }

        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10,10,10,0.98); display: flex; padding: 12px 0 24px; border-top: 1px solid #222; }
        .nav-item { flex: 1; text-align: center; background: none; border: none; color: #555; font-size: 12px; cursor: pointer; }
        .nav-item.active { color: var(--tg-button); }
        .tab { display: none; }
        .tab.active { display: block; }
        .copy-box { background: var(--bg-card); border-radius: 12px; padding: 16px; display: flex; align-items: center; justify-content: space-between; margin-top: 10px; }
        .copy-btn { background: rgba(36, 129, 204, 0.2); color: var(--tg-button); border: none; border-radius: 8px; padding: 8px 12px; font-size: 12px; font-weight: 700; }
    </style>
</head>
<body>
    <canvas id="stars"></canvas>
    <div class="app">
        <div class="content">
            <div id="shop-tab" class="tab active">
                <div class="promo-banner">
                    <div style="color:white"><b>Telegram Stars</b><br><span style="font-size:12px;opacity:0.8">–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞</span></div>
                    <div style="font-size:30px">‚≠ê</div>
                </div>
                
                <div class="input-group">
                    <div id="avatar-container" class="avatar-slot"><img id="dynamic-ava" src=""></div>
                    <input type="text" id="target-user" placeholder="@username" oninput="resolveUser()">
                    <button class="btn-self" onclick="setToMe()">–°–µ–±–µ</button>
                </div>

                <div class="input-group">
                    <input type="number" id="manual-count" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥" oninput="updatePriceManual()">
                </div>

                <div class="stars-grid">
                    <div class="star-card" onclick="selectPack(100, this)"><b>100 ‚≠ê</b><span>154 ‚ÇΩ</span></div>
                    <div class="star-card" onclick="selectPack(250, this)"><b>250 ‚≠ê</b><span>385 ‚ÇΩ</span></div>
                    <div class="star-card" onclick="selectPack(500, this)"><b>500 ‚≠ê</b><span>770 ‚ÇΩ</span></div>
                    <div class="star-card" onclick="selectPack(1000, this)"><b>1000 ‚≠ê</b><span>1540 ‚ÇΩ</span></div>
                    <div class="star-card" onclick="selectPack(5000, this)"><b>5000 ‚≠ê</b><span>7700 ‚ÇΩ</span></div>
                </div>

                <span class="label-txt">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</span>
                <div class="pay-grid">
                    <div class="pay-item active" onclick="selectPay('sbp', this)">–°–ë–ü</div>
                    <div class="pay-item" onclick="selectPay('card', this)">–ö–∞—Ä—Ç—ã (RUB)</div>
                </div>

                <button class="main-btn" id="pay-button" onclick="handleBuy()">–ö—É–ø–∏—Ç—å</button>
            </div>

            <div id="profile-tab" class="tab">
                <div style="background: var(--bg-card); border-radius: 16px; padding: 20px; text-align: center; margin-top: 40px;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: #222; margin: 0 auto 12px; overflow: hidden; border: 2px solid var(--tg-button);">
                        <img id="my-photo" src="" style="width:100%; height:100%; object-fit:cover;">
                    </div>
                    <b id="my-name">–ó–∞–≥—Ä—É–∑–∫–∞...</b>
                </div>
                <div class="copy-box">
                    <span id="ref-url" style="font-size: 11px; color: var(--tg-button); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 200px;">...</span>
                    <button class="copy-btn" onclick="copyRef()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="nav-bar">
            <button class="nav-item active" onclick="switchTab('shop-tab', this)"><div>üè†</div>–ú–∞–≥–∞–∑–∏–Ω</button>
            <button class="nav-item" onclick="switchTab('profile-tab', this)"><div>üë§</div>–ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.headerColor = '#000000'; tg.backgroundColor = '#000000';

        // –ù–ê–°–¢–†–û–ô–ö–ê –°–ï–†–í–ï–†–ê
        // –°—é–¥–∞ –≤—Å—Ç–∞–≤—å https —Å—Å—ã–ª–∫—É –æ—Ç ngrok –∏–ª–∏ http://–¢–í–û–ô_IP:8080 (–µ—Å–ª–∏ —Ç–µ—Å—Ç–∏—Ä—É–µ—à—å –±–µ–∑ SSL)
        const API_URL = "http://–¢–í–û–ô_IP_–ê–î–†–ï–°–ê:8080"; 

        const me = tg.initDataUnsafe.user || { username: '', id: 0, photo_url: '' };
        const RATE = 1.54;
        let currentPayMethod = 'sbp';
        
        document.getElementById('my-name').innerText = me.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        document.getElementById('ref-url').innerText = 'https://t.me/BapeStarsBot?start=' + me.id;
        if(me.photo_url) document.getElementById('my-photo').src = me.photo_url;

        let searchTimer;

        // === –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–û–ò–°–ö–ê –ê–í–ê–¢–ê–†–ö–ò ===
        async function resolveUser() {
            const input = document.getElementById('target-user').value.replace('@', '').trim();
            const slot = document.getElementById('avatar-container');
            const img = document.getElementById('dynamic-ava');

            // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ - –ø—Ä—è—á–µ–º –∞–≤—É
            if(input.length < 3) { 
                slot.classList.remove('visible'); 
                return; 
            }

            clearTimeout(searchTimer);
            
            // –ñ–¥–µ–º –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫–æ–Ω—á–∏—Ç –ø–µ—á–∞—Ç–∞—Ç—å (500–º—Å)
            searchTimer = setTimeout(async () => {
                // –ï—Å–ª–∏ –≤–≤–µ–ª–∏ —Å–≤–æ–π –Ω–∏–∫
                if(input === me.username && me.photo_url) {
                    img.src = me.photo_url;
                    slot.classList.add('visible');
                    return;
                }

                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –∞–≤—É —á–µ—Ä–µ–∑ —Ç–≤–æ–µ–≥–æ –±–æ—Ç–∞
                try {
                    const response = await fetch(`${API_URL}/avatar/${input}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        if(data.found && data.url) {
                            img.src = data.url;
                        } else {
                            // –ï—Å–ª–∏ —é–∑–µ—Ä –µ—Å—Ç—å, –Ω–æ –Ω–µ—Ç —Ñ–æ—Ç–æ - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É —Å –±—É–∫–≤–∞–º–∏
                            img.src = `https://ui-avatars.com/api/?name=${input}&background=2481cc&color=fff`;
                        }
                    } else {
                         throw new Error('Not found');
                    }
                } catch (e) {
                    console.log("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", e);
                    // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - —Å—Ç–∞–≤–∏–º –∫—Ä–∞—Å–∏–≤—É—é –∑–∞–≥–ª—É—à–∫—É
                    img.src = `https://ui-avatars.com/api/?name=${input}&background=2481cc&color=fff`;
                }
                
                // –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–ª–∞–≤–Ω–æ
                slot.classList.add('visible');

            }, 500);
        }

        function setToMe() { document.getElementById('target-user').value = me.username; resolveUser(); }
        
        function selectPack(val, el) {
            document.querySelectorAll('.star-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('manual-count').value = val;
            updatePriceBtn(val);
        }

        function updatePriceManual() {
            document.querySelectorAll('.star-card').forEach(c => c.classList.remove('active'));
            const val = document.getElementById('manual-count').value;
            updatePriceBtn(val);
        }

        function updatePriceBtn(val) {
            const btn = document.getElementById('pay-button');
            btn.innerText = val > 0 ? `–ö—É–ø–∏—Ç—å –∑–∞ ${Math.ceil(val * RATE)} ‚ÇΩ` : '–ö—É–ø–∏—Ç—å';
        }

        function selectPay(method, el) {
            document.querySelectorAll('.pay-item').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            currentPayMethod = method;
        }

        function handleBuy() {
            const v = document.getElementById('manual-count').value;
            const to = document.getElementById('target-user').value;
            if(!v || !to) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!");
            tg.sendData(JSON.stringify({stars: v, to: to, method: currentPayMethod}));
        }

        function copyRef() { navigator.clipboard.writeText(document.getElementById('ref-url').innerText); tg.showAlert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"); }
        function switchTab(id, el) { 
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active'); el.classList.add('active');
        }

        // –ó–í–ï–ó–î–´
        const canvas = document.getElementById('stars');
        const ctx = canvas.getContext('2d');
        let w, h, dots = [];
        function init() {
            w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight;
            dots = Array.from({length: 100}, () => ({ 
                x: Math.random()*w, y: Math.random()*h, 
                r: Math.random()*2.5 + 0.5, 
                s: Math.random()*0.5 + 0.2 
            }));
        }
        function draw() {
            ctx.clearRect(0,0,w,h); ctx.fillStyle = "#fff";
            dots.forEach(d => {
                ctx.beginPath(); ctx.arc(d.x, d.y, d.r, 0, Math.PI*2); ctx.fill();
                d.y += d.s; if(d.y > h) d.y = -5;
            });
            requestAnimationFrame(draw);
        }
        init(); draw(); window.onresize = init;
    </script>
</body>
</html>
