<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stars Shop Premium</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }
        body {
            margin: 0; background-color: #000; color: #fff;
            font-family: -apple-system, system-ui, sans-serif;
            overflow: hidden; height: 100vh; display: flex; flex-direction: column;
        }
        canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 0; }
        
        .container { position: relative; z-index: 1; padding: 20px; flex: 1; overflow-y: auto; padding-bottom: 100px; }

        /* HEADER & PROFILE */
        .profile-header { 
            display: flex; align-items: center; gap: 15px; margin-bottom: 25px; 
            background: rgba(255,255,255,0.05); padding: 15px; border-radius: 20px; 
            border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px);
        }
        .avatar-container { width: 55px; height: 55px; border-radius: 50%; overflow: hidden; border: 2px solid #34c759; background: #222; }
        .avatar-container img { width: 100%; height: 100%; object-fit: cover; }
        
        .user-info h2 { margin: 0; font-size: 17px; font-weight: 700; }
        .level-tag { color: #34c759; font-size: 11px; font-weight: 800; text-transform: uppercase; }

        /* TABS */
        .tabs-content { display: none; }
        .tabs-content.active { display: block; animation: fadeIn 0.3s ease; }

        /* CARDS */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .card {
            background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 18px; padding: 18px; text-align: center; transition: 0.2s;
        }
        .card.selected { border-color: #34c759; background: rgba(52, 199, 89, 0.1); }
        .card b { font-size: 22px; display: block; margin-bottom: 4px; }
        .card span { font-size: 13px; color: #888; font-weight: 500; }

        /* INPUT BLOCK */
        .input-block {
            background: rgba(255,255,255,0.05); border-radius: 18px; padding: 16px;
            display: flex; align-items: center; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.1);
        }
        .input-block input { background: transparent; border: none; color: #fff; font-size: 16px; width: 100%; font-weight: 600; }
        .price-result { color: #34c759; font-weight: 800; font-size: 16px; }

        /* REFERRAL BOX */
        .ref-section { background: rgba(52, 199, 89, 0.08); border: 1px dashed rgba(52, 199, 89, 0.5); padding: 20px; border-radius: 20px; text-align: center; }
        .ref-title { font-weight: 700; font-size: 18px; display: block; margin-bottom: 5px; }
        .ref-link { font-size: 11px; background: #000; padding: 10px; border-radius: 10px; margin: 15px 0; display: block; color: #34c759; border: 1px solid #333; }

        /* NAVIGATION */
        .nav-bar {
            position: fixed; bottom: 25px; left: 20px; right: 20px;
            background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(20px);
            border-radius: 22px; display: flex; padding: 6px; border: 1px solid rgba(255,255,255,0.1); z-index: 100;
        }
        .nav-item { flex: 1; padding: 12px; border: none; background: transparent; color: #666; font-weight: 700; border-radius: 18px; font-size: 14px; }
        .nav-item.active { background: #fff; color: #000; }

        .btn-main { width: 100%; padding: 18px; border-radius: 18px; border: none; background: #34c759; color: #fff; font-weight: 800; font-size: 16px; cursor: pointer; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <canvas id="snow-canvas"></canvas>
    
    <div class="container">
        <div id="shop-tab" class="tabs-content active">
            <div class="profile-header">
                <div class="avatar-container"><img id="main-avatar" src=""></div>
                <div class="user-info">
                    <h2 id="main-name">Загрузка...</h2>
                    <span class="level-tag">Premium Member ⚡️</span>
                </div>
            </div>

            <h4 style="margin: 0 0 15px 5px; color: #888;">Выберите пакет звезд</h4>
            <div class="grid">
                <div class="card" onclick="pick(100, 160, this)"><b>100 ⭐</b><span>160 ₽</span></div>
                <div class="card" onclick="pick(250, 400, this)"><b>250 ⭐</b><span>400 ₽</span></div>
                <div class="card" onclick="pick(500, 800, this)"><b>500 ⭐</b><span>800 ₽</span></div>
                <div class="card" onclick="pick(1000, 1600, this)"><b>1000 ⭐</b><span>1600 ₽</span></div>
            </div>

            <div class="input-block">
                <input type="number" id="manual-inp" placeholder="Свое количество..." oninput="calculate()">
                <span class="price-result" id="res-val">0 ₽</span>
            </div>

            <h4 style="margin: 0 0 15px 5px; color: #888;">Подписки</h4>
            <div class="grid">
                <div class="card" onclick="pick('Prem 3M', 450, this)"><b>3 мес.</b><span>450 ₽</span></div>
                <div class="card" onclick="pick('Prem 1Y', 1350, this)"><b>1 год</b><span>1350 ₽</span></div>
            </div>
            
            <button class="btn-main" onclick="confirmOrder()">ОПЛАТИТЬ</button>
        </div>

        <div id="profile-tab" class="tabs-content">
            <div style="text-align: center; margin: 20px 0;">
                <div class="avatar-container" style="width: 90px; height: 90px; margin: 0 auto 15px; border-width: 3px;">
                    <img id="big-avatar" src="">
                </div>
                <h2 id="big-name" style="font-size: 24px; margin-bottom: 5px;">User</h2>
                <div class="level-tag">Уровень: Новичок</div>
            </div>
            
            <div class="ref-section">
                <span class="ref-title">Реферальная программа</span>
                <span style="font-size: 13px; color: #aaa;">Приглашай друзей и получай 5% бонусов с каждой их покупки!</span>
                <span class="ref-link" id="referral-url">Загрузка ссылки...</span>
                <button onclick="copyToClipboard()" style="background:#fff; color:#000; border:none; padding:8px 20px; border-radius:10px; font-weight:700; font-size:12px;">КОПИРОВАТЬ</button>
            </div>

            <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:15px; text-align:center;">
                    <span style="display:block; color:#888; font-size:11px;">Покупок</span>
                    <b style="font-size:18px;">0 ₽</b>
                </div>
                <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:15px; text-align:center;">
                    <span style="display:block; color:#888; font-size:11px;">Друзей</span>
                    <b style="font-size:18px;">0</b>
                </div>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <button id="nav-shop" class="nav-item active" onclick="changeTab('shop')">Магазин</button>
        <button id="nav-prof" class="nav-item" onclick="changeTab('prof')">Профиль</button>
    </div>

    <script>
        const webapp = window.Telegram.WebApp;
        webapp.expand();
        webapp.enableClosingConfirmation();

        // ПОЛУЧЕНИЕ ДАННЫХ
        const userData = webapp.initDataUnsafe.user || { first_name: 'Пользователь', id: 0 };
        document.getElementById('main-name').innerText = userData.first_name;
        document.getElementById('big-name').innerText = userData.first_name;
        document.getElementById('referral-url').innerText = 'https://t.me/StarsShopBot?start=' + userData.id;

        // Обработка аватара
        const photo = userData.photo_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
        document.getElementById('main-avatar').src = photo;
        document.getElementById('big-avatar').src = photo;

        let currentSelection = null;

        function changeTab(tab) {
            document.querySelectorAll('.tabs-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(tab === 'shop') {
                document.getElementById('shop-tab').classList.add('active');
                document.getElementById('nav-shop').classList.add('active');
            } else {
                document.getElementById('profile-tab').classList.add('active');
                document.getElementById('nav-prof').classList.add('active');
            }
        }

        function pick(v, p, el) {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            currentSelection = { val: v, price: p };
            document.getElementById('manual-inp').value = '';
            document.getElementById('res-val').innerText = '0 ₽';
        }

        function calculate() {
            const val = document.getElementById('manual-inp').value;
            const price = Math.ceil(val * 1.6);
            document.getElementById('res-val').innerText = price + ' ₽';
            document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
            if(val > 0) currentSelection = { val: val + ' Stars', price: price };
        }

        function confirmOrder() {
            if(!currentSelection) return webapp.showAlert("Пожалуйста, выберите количество звезд!");
            webapp.sendData(JSON.stringify(currentSelection));
        }

        function copyToClipboard() {
            const url = document.getElementById('referral-url').innerText;
            navigator.clipboard.writeText(url).then(() => {
                webapp.showAlert("Ссылка скопирована!");
            });
        }

        // АНИМАЦИЯ ФОНА
        const canvas = document.getElementById('snow-canvas');
        const ctx = canvas.getContext('2d');
        let w, h, dots = [];
        function init() {
            w = canvas.width = window.innerWidth;
            h = canvas.height = window.innerHeight;
            dots = Array.from({length: 45}, () => ({ x: Math.random()*w, y: Math.random()*h, r: Math.random()*1.5+0.5, s: Math.random()*0.3+0.1 }));
        }
        function draw() {
            ctx.clearRect(0,0,w,h);
            ctx.fillStyle = "rgba(255,255,255,0.3)";
            ctx.beginPath();
            dots.forEach(d => { ctx.moveTo(d.x, d.y); ctx.arc(d.x, d.y, d.r, 0, Math.PI*2); d.y += d.s; if(d.y > h) d.y = -5; });
            ctx.fill();
            requestAnimationFrame(draw);
        }
        init(); draw(); window.onresize = init;
    </script>
</body>
</html>