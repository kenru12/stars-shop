<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stars Shop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg-pure: #000; --bg-card: #121212; --tg-button: #2481cc; --tg-hint: #888; }
        body { margin: 0; background: var(--bg-pure); color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; height: 100vh; }
        canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 0; opacity: 0.3; }
        .app { position: relative; z-index: 1; height: 100vh; display: flex; flex-direction: column; }
        .content { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 120px; }

        .promo-banner {
            background: linear-gradient(135deg, #1d2733 0%, #2481cc 100%);
            border-radius: 16px; padding: 20px; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: space-between;
        }

        .input-group { 
            background: var(--bg-card); border-radius: 14px; padding: 4px 12px; 
            margin-bottom: 12px; display: flex; align-items: center; min-height: 56px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .avatar-slot { 
            width: 0; height: 34px; border-radius: 50%; overflow: hidden; margin-right: 0; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; transform: scale(0.5);
        }
        .avatar-slot.visible { width: 34px; margin-right: 12px; opacity: 1; transform: scale(1); }
        .avatar-slot img { width: 100%; height: 100%; object-fit: cover; }

        input { flex: 1; background: transparent; border: none; color: #fff; font-size: 16px; outline: none; }
        .btn-self { background: var(--tg-button); color: #fff; border: none; border-radius: 18px; padding: 6px 14px; font-size: 13px; font-weight: 600; }

        .main-btn { background: var(--tg-button); color: #fff; width: 100%; border: none; border-radius: 14px; padding: 16px; font-size: 16px; font-weight: 700; margin-top: 20px; }

        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10,10,10,0.98); display: flex; padding: 12px 0 24px; border-top: 1px solid #222; }
        .nav-item { flex: 1; text-align: center; background: none; border: none; color: #555; font-size: 12px; }
        .nav-item.active { color: var(--tg-button); }
        .tab { display: none; }
        .tab.active { display: block; }

        .copy-box { background: var(--bg-card); border-radius: 12px; padding: 16px; display: flex; align-items: center; justify-content: space-between; margin-top: 10px; }
        .copy-btn { background: rgba(36, 129, 204, 0.2); color: var(--tg-button); border: none; border-radius: 8px; padding: 8px 12px; font-size: 12px; font-weight: 700; }
    </style>
</head>
<body>
    <canvas id="stars"></canvas>
    <div class="app">
        <div class="content">
            <div id="shop-tab" class="tab active">
                <div class="promo-banner">
                    <div style="color:white"><b>Telegram Stars</b><br><span style="font-size:12px;opacity:0.8">–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞</span></div>
                    <div style="font-size:30px">‚≠ê</div>
                </div>
                
                <div class="input-group">
                    <div id="avatar-container" class="avatar-slot"><img id="dynamic-ava" src=""></div>
                    <input type="text" id="target-user" placeholder="@username" oninput="resolveUser()">
                    <button class="btn-self" onclick="setToMe()">–°–µ–±–µ</button>
                </div>

                <div class="input-group">
                    <input type="number" id="manual-count" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥" oninput="updatePrice()">
                </div>

                <button class="main-btn" id="pay-button" onclick="handleBuy()">–ö—É–ø–∏—Ç—å</button>
            </div>

            <div id="profile-tab" class="tab">
                <div style="background: var(--bg-card); border-radius: 16px; padding: 20px; text-align: center;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: #222; margin: 0 auto 12px; overflow: hidden; border: 2px solid var(--tg-button);">
                        <img id="my-photo" src="" style="width:100%; height:100%; object-fit:cover;">
                    </div>
                    <b id="my-name">–ó–∞–≥—Ä—É–∑–∫–∞...</b>
                </div>
                <div class="copy-box">
                    <span id="ref-url" style="font-size: 11px; color: var(--tg-button); overflow: hidden;">...</span>
                    <button class="copy-btn" onclick="copyRef()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="nav-bar">
            <button class="nav-item active" onclick="switchTab('shop-tab', this)"><div>üè†</div>–ú–∞–≥–∞–∑–∏–Ω</button>
            <button class="nav-item" onclick="switchTab('profile-tab', this)"><div>üë§</div>–ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const me = tg.initDataUnsafe.user || { username: '', id: 0, photo_url: '' };
        
        document.getElementById('my-name').innerText = me.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        document.getElementById('ref-url').innerText = 'https://t.me/BapeStarsBot?start=' + me.id;
        if(me.photo_url) document.getElementById('my-photo').src = me.photo_url;

        let searchTimer;

        // –≠–¢–ê –§–£–ù–ö–¶–ò–Ø –ë–£–î–ï–¢ –ó–ê–ü–†–ê–®–ò–í–ê–¢–¨ –ê–í–£ –£ –í–ê–®–ï–ì–û main.py
        async function resolveUser() {
            const input = document.getElementById('target-user').value.replace('@', '').trim();
            const slot = document.getElementById('avatar-container');
            const img = document.getElementById('dynamic-ava');

            if(input.length < 3) { slot.classList.remove('visible'); return; }

            clearTimeout(searchTimer);
            searchTimer = setTimeout(async () => {
                if(input === me.username) {
                    img.src = me.photo_url;
                    slot.classList.add('visible');
                } else {
                    // –ò–º–∏—Ç–∞—Ü–∏—è/–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–æ–¥ –∑–∞–ø—Ä–æ—Å –∫ –±–æ—Ç—É
                    // –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å—Ç–∏–º main.py, –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å fetch –∑–∞–ø—Ä–æ—Å
                    img.src = 'https://ui-avatars.com/api/?name=' + input + '&background=2481cc&color=fff';
                    slot.classList.add('visible');
                }
            }, 500);
        }

        function setToMe() { document.getElementById('target-user').value = me.username; resolveUser(); }
        function copyRef() { navigator.clipboard.writeText(document.getElementById('ref-url').innerText); tg.showAlert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"); }
        function switchTab(id, el) { 
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active'); el.classList.add('active');
        }
        function updatePrice() {
            const val = document.getElementById('manual-count').value;
            document.getElementById('pay-button').innerText = val > 0 ? `–ö—É–ø–∏—Ç—å –∑–∞ ${Math.ceil(val * 1.54)} ‚ÇΩ` : '–ö—É–ø–∏—Ç—å';
        }
        function handleBuy() {
            const v = document.getElementById('manual-count').value;
            const to = document.getElementById('target-user').value;
            if(!v || !to) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!");
            tg.sendData(JSON.stringify({stars: v, to: to}));
        }

        // Stars Background
        const canvas = document.getElementById('stars');
        const ctx = canvas.getContext('2d');
        let w, h, dots = [];
        function init() {
            w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight;
            dots = Array.from({length: 40}, () => ({ x: Math.random()*w, y: Math.random()*h, r: Math.random()*1.2, s: Math.random()*0.3+0.1 }));
        }
        function draw() {
            ctx.clearRect(0,0,w,h); ctx.fillStyle = "#fff";
            dots.forEach(d => {
                ctx.beginPath(); ctx.arc(d.x, d.y, d.r, 0, Math.PI*2); ctx.fill();
                d.y += d.s; if(d.y > h) d.y = -5;
            });
            requestAnimationFrame(draw);
        }
        init(); draw();
    </script>
</body>
</html>