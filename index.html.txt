<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stars Shop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-pure: #0b141d;
            --bg-card: #1c2732;
            --tg-button: #2481cc;
            --tg-hint: #7d8b99;
            --gold: #f9d43d;
        }

        body {
            margin: 0; background-color: var(--bg-pure); color: #fff;
            font-family: -apple-system, system-ui, sans-serif;
            overflow: hidden; height: 100vh;
        }

        canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 0; opacity: 0.8; }
        
        .app { position: relative; z-index: 1; height: 100vh; display: flex; flex-direction: column; }
        .content { flex: 1; overflow-y: auto; padding: 16px; padding-top: 50px; padding-bottom: 120px; }

        /* –ë–ê–ù–ï–† */
        .promo-banner {
            background: linear-gradient(135deg, #1d2733 0%, #2481cc 100%);
            border-radius: 16px; padding: 20px; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: space-between;
        }

        /* –ò–ù–ü–£–¢ –ì–†–£–ü–ü–ê */
        .input-container { position: relative; margin-bottom: 12px; }
        .input-group { 
            background: var(--bg-card); border-radius: 14px; 
            padding: 4px 12px; display: flex; align-items: center; min-height: 58px;
        }
        
        /* –ü–õ–ê–í–ù–ê–Ø –ê–í–ê–¢–ê–†–ö–ê */
        .avatar-slot { 
            width: 0; height: 36px; border-radius: 50%; 
            overflow: hidden; margin-right: 0; 
            opacity: 0; transform: scale(0.5);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        .avatar-slot.visible { width: 36px; margin-right: 12px; opacity: 1; transform: scale(1); }
        .avatar-slot img { width: 100%; height: 100%; object-fit: cover; }

        input { flex: 1; background: transparent; border: none; color: #fff; font-size: 16px; outline: none; }
        .btn-self { background: var(--tg-button); color: #fff; border: none; border-radius: 18px; padding: 8px 16px; font-size: 14px; font-weight: 600; }

        /* –ü–û–î–¢–í–ï–†–ñ–î–ê–Æ–©–ê–Ø –ì–ê–õ–û–ß–ö–ê (–∫–∞–∫ –Ω–∞ –≤–∏–¥–µ–æ) */
        .check-mark { 
            display: none; width: 20px; height: 20px; background: var(--tg-button); 
            border-radius: 50%; color: white; font-size: 12px; 
            align-items: center; justify-content: center; margin-left: 8px;
        }
        .check-mark.active { display: flex; }

        /* –ü–ê–ö–ï–¢–´ –ó–í–ï–ó–î */
        .stars-grid { display: flex; overflow-x: auto; gap: 10px; margin: 20px 0; scrollbar-width: none; }
        .stars-grid::-webkit-scrollbar { display: none; }
        .star-card { 
            background: var(--bg-card); border-radius: 14px; 
            padding: 12px 18px; display: flex; align-items: center; gap: 8px;
            border: 1.5px solid transparent; transition: 0.2s; flex-shrink: 0;
        }
        .star-card.active { border-color: var(--gold); background: rgba(249, 212, 61, 0.1); }
        .star-card b { color: var(--gold); font-size: 16px; }

        /* –û–ü–õ–ê–¢–ê (–ö–ê–ö –ù–ê –í–ò–î–ï–û) */
        .label-txt { color: var(--tg-hint); font-size: 15px; margin: 20px 0 12px; display: block; font-weight: 600; }
        .pay-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .pay-item { 
            background: var(--bg-card); border-radius: 16px; padding: 20px 10px; 
            text-align: center; border: 2px solid transparent; transition: 0.2s;
        }
        .pay-item.active { border-color: var(--tg-button); }
        .pay-item img { height: 30px; margin-bottom: 8px; display: block; margin-left: auto; margin-right: auto; }
        .pay-item span { font-size: 13px; color: var(--tg-hint); font-weight: 500; }

        .main-btn { 
            background: var(--tg-button); color: #fff; width: 100%; border: none; 
            border-radius: 16px; padding: 18px; font-size: 17px; font-weight: 700; margin-top: 25px;
        }

        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #0b141d; display: flex; padding: 15px 0 30px; border-top: 1px solid #1c2732; }
        .nav-item { flex: 1; text-align: center; background: none; border: none; color: #555; font-size: 12px; }
        .nav-item.active { color: var(--tg-button); }
        .tab { display: none; }
        .tab.active { display: block; }
    </style>
</head>
<body>
    <canvas id="stars"></canvas>
    <div class="app">
        <div class="content">
            <div id="shop-tab" class="tab active">
                <div class="promo-banner">
                    <div><b>–ü–æ–∫—É–ø–∞–π –∑–≤–µ–∑–¥—ã –≤ –æ–¥–∏–Ω –∫–ª–∏–∫</b><br><span style="font-size:12px;opacity:0.8">–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</span></div>
                    <div style="font-size:35px">‚≠ê</div>
                </div>
                
                <div class="input-group">
                    <div id="avatar-container" class="avatar-slot"><img id="dynamic-ava" src=""></div>
                    <input type="text" id="target-user" placeholder="–í–≤–µ–¥–∏—Ç–µ username" oninput="resolveUser()">
                    <button class="btn-self" onclick="setToMe()">–°–µ–±–µ</button>
                    <div id="check-mark" class="check-mark">‚úì</div>
                </div>

                <div class="input-group" style="margin-top:12px">
                    <span style="color:var(--gold); margin-right:10px">‚≠ê</span>
                    <input type="number" id="manual-count" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥" oninput="updatePriceManual()">
                </div>

                <div class="stars-grid">
                    <div class="star-card" onclick="selectPack(100, this)"><b>100 ‚òÖ</b></div>
                    <div class="star-card" onclick="selectPack(250, this)"><b>250 ‚òÖ</b></div>
                    <div class="star-card" onclick="selectPack(500, this)"><b>500 ‚òÖ</b></div>
                    <div class="star-card" onclick="selectPack(1000, this)"><b>1000 ‚òÖ</b></div>
                    <div class="star-card" onclick="selectPack(5000, this)"><b>5000 ‚òÖ</b></div>
                </div>

                <span class="label-txt">–û–ø–ª–∞—Ç–∞</span>
                <div class="pay-grid">
                    <div class="pay-item active" onclick="selectPay('sbp', this)">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_–∫–æ–¥_–°–ë–ü.svg" alt="–°–ë–ü">
                        <span>–°–ë–ü</span>
                    </div>
                    <div class="pay-item" onclick="selectPay('card', this)">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/a/a4/Mir-logo.SVG.png" alt="–ú–∏—Ä">
                        <span>–ö–∞—Ä—Ç—ã (RUB)</span>
                    </div>
                </div>

                <button class="main-btn" id="pay-button" onclick="handleBuy()">–ö—É–ø–∏—Ç—å</button>
            </div>
        </div>

        <div class="nav-bar">
            <button class="nav-item active">üè†<br>–ú–∞–≥–∞–∑–∏–Ω</button>
            <button class="nav-item">üë§<br>–ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.headerColor = '#0b141d'; 
        
        // –¢–í–û–ô IP –ò–ó –°–ö–†–ò–ù–®–û–¢–ê
        const API_URL = "http://77.232.128.243:8080"; 
        const me = tg.initDataUnsafe.user || { username: '', photo_url: '' };
        const RATE = 1.54;

        let searchTimer;
        async function resolveUser() {
            const input = document.getElementById('target-user').value.replace('@', '').trim();
            const slot = document.getElementById('avatar-container');
            const img = document.getElementById('dynamic-ava');
            const check = document.getElementById('check-mark');

            if(input.length < 3) { 
                slot.classList.remove('visible'); 
                check.classList.remove('active');
                return; 
            }

            clearTimeout(searchTimer);
            searchTimer = setTimeout(async () => {
                try {
                    const response = await fetch(`${API_URL}/avatar/${input}`);
                    const data = await response.json();
                    if(data.found) {
                        img.src = data.url;
                        slot.classList.add('visible');
                        check.classList.add('active');
                    }
                } catch (e) {
                    img.src = `https://ui-avatars.com/api/?name=${input}&background=2481cc&color=fff`;
                    slot.classList.add('visible');
                    check.classList.add('active');
                }
            }, 600);
        }

        function setToMe() { 
            document.getElementById('target-user').value = me.username; 
            resolveUser(); 
        }
        
        function selectPack(val, el) {
            document.querySelectorAll('.star-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('manual-count').value = val;
            updatePriceBtn(val);
        }

        function updatePriceManual() {
            document.querySelectorAll('.star-card').forEach(c => c.classList.remove('active'));
            updatePriceBtn(document.getElementById('manual-count').value);
        }

        function updatePriceBtn(val) {
            const btn = document.getElementById('pay-button');
            btn.innerText = val > 0 ? `–ö—É–ø–∏—Ç—å –∑–∞ ${Math.ceil(val * RATE)} ‚ÇΩ` : '–ö—É–ø–∏—Ç—å';
        }

        function selectPay(method, el) {
            document.querySelectorAll('.pay-item').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        }

        function handleBuy() {
            const v = document.getElementById('manual-count').value;
            const to = document.getElementById('target-user').value;
            if(!v || !to) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!");
            tg.sendData(JSON.stringify({stars: v, to: to}));
        }

        // –ö–†–ê–°–ò–í–´–ô –§–û–ù
        const canvas = document.getElementById('stars');
        const ctx = canvas.getContext('2d');
        let w, h, dots = [];
        function init() {
            w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight;
            dots = Array.from({length: 120}, () => ({ 
                x: Math.random()*w, y: Math.random()*h, 
                r: Math.random()*2.2 + 0.3, 
                s: Math.random()*0.5 + 0.1 
            }));
        }
        function draw() {
            ctx.clearRect(0,0,w,h); ctx.fillStyle = "#ffffff";
            dots.forEach(d => {
                ctx.beginPath(); ctx.arc(d.x, d.y, d.r, 0, Math.PI*2); ctx.fill();
                d.y += d.s; if(d.y > h) d.y = -5;
            });
            requestAnimationFrame(draw);
        }
        init(); draw();
    </script>
</body>
</html>